#!/bin/bash
# Author: terminada.io 20211031 updated 20250527
set -o nounset
set -o errexit
set -o pipefail

CONFIG_DIR='/etc/cardano' #FIXME
CONFIG_NET='mainnet' #FIXME mainnet|preprod|preview
export CARDANO_NODE_SOCKET_PATH="/run/cardano/${CONFIG_NET}/node.socket"
# If sending to pooltool then must set POOL_ID and POOLTOOL_API_KEY
pool_id_file="${CONFIG_DIR}/${CONFIG_NET}/pool-id" #FIXME
pooltool_api_key_file="${CONFIG_DIR}/${CONFIG_NET}/pooltool-api-key" #FIXME
node_id_file="${CONFIG_DIR}/${CONFIG_NET}/node-id" #FIXME

# https://forum.cardano.org/t/and-so-it-begins-reflections-on-this-first-shelley-epoch/37544
# Shelley first slot: "2020-07-29 21:44:51 UTC", epoch 208, slot 4492800
# printf '%s\n' "$(date -d"2020-07-29 21:44:51 UTC" "+%s") - 4492800" | bc # == 1591566291
slot0sec=1591566291 # Slot 0 seconds since 1970-01-01 00:00:00 UTC

function usage() {
  cat << END_OF_USAGE >&2
Usage: $(basename $0) [-s | --send]
Follow system journal and print delay ms as each block added to tip

    -s, --send        send information to pooltool.io
    -h, --help        display this help and exit

END_OF_USAGE
}

function err_exit() {
  printf '%s\n' "$1" >&2
  exit "${2:-1}"
}

function file_key_value() {
  local f k v
  f="$1"
  k="$2"
  if [[ -z "${f:-}" || -z "${k:-}" || ! -f "${f}" ]]; then
    return 1
  fi
  while read -r line; do
    v="$(printf '%s\n' "${line}" | sed -nr "s/^\s*${k}\s*=\s*["\""']?([^[:space:]"\""']+)["\""']?\s*(#.*)?$/\1/p")"
    if [ -n "${v:-}" ]; then
      break
    fi
  done <<< "$(grep -Ev '^\s*#|^\s*$' "${f}")" # Skip comment and blank lines
  if [ -z "${v:-}" ]; then
    return 1
  fi
  printf '%s\n' "${v}"
  return 0
}

function send_pooltool() {
  local atutc hash block slot
  atutc="$1"; hash="$2"; block="$3"; slot="$4";
  json="$(jq -cn --arg apiKey "$api_key" --arg poolId "$pool_id" \
    --arg nodeId "$node_id" --arg version "$version" --arg at "$atutc" \
    --arg blockNo "$block" --arg slotNo "$slot" \
    --arg blockHash "$hash" --arg platform "$platform" \
    '{apiKey: $apiKey, poolId: $poolId, data: {nodeId: $nodeId, version: $version, at: $at, blockNo: $blockNo | tonumber, slotNo: $slotNo | tonumber, blockHash: $blockHash, platform: $platform}}')"
  response="$(curl -s -H "Accept: application/json" -H "Content-Type:application/json" -X POST --data "$json" 'https://api.pooltool.io/v0/sendstats' || true)" # '' if curl fails
  success="$(printf '%s\n' "${response:-}" | jq -r '.success')"
  if [[ "$success" == 'true' ]]; then result='success'; else result='failure'; fi;
  printf 'Sent pooltool: %s Response: %s\n' "at=${atutc},hash=${hash},block=${block},slot=${slot}" "$result"
}

# Process optional command line arguments
while [[ $# -gt 0 && "${1:0:1}" = '-' ]]; do
  opt="${1}"
  shift
  case "${opt}" in
    '-s' | '--send' ) optsend='true';;
    '-h' | '--help' ) usage; exit 0;;
    * ) printf '%s\n' "Invalid option: '${opt}'" >&2; err_exit "Try '$(basename $0) --help' for more information";;
  esac
done

# If sending to pooltool, set variables required
if [[ "${optsend:-}" == "true" ]]; then
  pool_id="$(file_key_value "${pool_id_file}" 'POOL_ID')" || err_exit "${pool_id_file} must contain POOL_ID=VALUE"
  api_key="$(file_key_value "${pooltool_api_key_file}" 'POOLTOOL_API_KEY')" || err_exit "${pooltool_api_key_file} must contain POOLTOOL_API_KEY=VALUE"
  node_id="$(file_key_value "${node_id_file}" 'NODE_ID')" || node_id='' # default
  platform="$(basename $0)"
  [[ "$(cardano-cli --version)" =~ cardano-cli\ ([\.0-9]+)\ .*rev\ ([a-f0-9]+)$ ]] || err_exit 'cardano-cli --version error'
  version="${BASH_REMATCH[1]}:${BASH_REMATCH[2]:0:5}"
fi

printf '%s\n' "$(basename $0) following journal:"

# regex for log when new block received "Chain extended, new tip:"
regex='^[^\{]+(\{.*,"ns":"ChainDB.AddBlockEvent.AddedToCurrentChain".*\})$'
# follow journal unit cardano-node < <(journalctl -fn0 -u cardano-node)
while IFS= read -r line; do
  [[ "${line:-}" =~ $regex ]] || continue # skip unless ChainDB.AddBlockEvent.AddedToCurrentChain
  logjson="${BASH_REMATCH[1]}"
  #printf '%s\n' "${logjson}"
  #echo "${logjson}" | jq -r '.'
  read -r at newtip chainlength slotno < <(echo "${logjson}" | jq -r '[.at, .data.newtip, (.data.newTipSelectView | .chainLength, .slotNo)] | @tsv')
  atsecs="$(date --date ${at} +%s.%9N)"
  delay="$(printf '%s\n' "${atsecs} - ${slot0sec} - ${slotno}" | bc)"
  printf '%s: Hash=%s,Block=%s,Slot=%d,Delay=%0.3f\n' "${at}" "${newtip}" "${chainlength}" "${slotno}" "${delay}"
  [[ "${optsend:-}" == 'true' ]] && send_pooltool "${at}" "${newtip}" "${chainlength}" "${slotno}"
done < <(journalctl -fn0 -u cardano-node)

exit 0
